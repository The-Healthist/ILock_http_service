# iLock 服务迁移简易部署指南

本指南提供简单步骤，帮助您将 iLock 服务从一个服务器迁移到另一个服务器。适用于新的项目结构。

## 快速开始

### 1. 准备工作

确保已安装 sshpass：
- macOS: `brew install hudochenkov/sshpass/sshpass`
- Linux: `sudo apt-get install sshpass`

### 2. 备份源服务器数据

```bash
cd scripts/migrate
./backup.sh
```

执行后，备份文件将保存在 `./backups` 目录中，包括数据库、Redis数据、环境配置和configs目录。

### 3. 部署到目标服务器

```bash
cd scripts/migrate
./deploy.sh
```

此脚本会自动检查目标服务器环境，安装必要组件，并部署应用。

### 4. 验证部署

访问 `http://目标服务器IP:20033/api/ping` 检查服务是否正常响应。

### 5. 回滚（如需）

如果部署出现问题，可以回滚到指定版本：

```bash
cd scripts/migrate
./rollback.sh 1.3.0  # 替换为你需要回滚的版本号
```

## 高级选项

### 自定义配置

在执行脚本前，可以设置以下环境变量来自定义配置：

**备份源服务器：**
```bash
export SSH_HOST="39.108.49.167"  # 源服务器IP
export SSH_PORT="22"
export SSH_USER="root"
export SSH_PASS="你的密码"
```

**部署到目标服务器：**
```bash
export TARGET_HOST="117.72.193.54"  # 目标服务器IP
export TARGET_PORT="22"
export TARGET_USER="root"
export TARGET_PASS="你的密码"
export VERSION="1.4.0"  # 指定版本号
```

### 只恢复数据

如果只需要恢复数据而不进行完整部署：

```bash
cd scripts/migrate
./restore.sh
```

## 目录结构说明

新的项目结构将配置文件放在 `/configs` 目录下：

```
ilock/
├── configs/               # 配置文件目录
│   ├── mysql/             # MySQL初始化脚本
│   ├── redis/             # Redis配置
│   └── mqtt/              # MQTT配置
├── logs/                  # 日志目录
├── mqtt/                  # MQTT数据目录
│   ├── data/              # MQTT数据
│   └── log/               # MQTT日志
├── .env                   # 环境变量
└── docker-compose.yml     # Docker编排文件
```

## 常见问题

- **部署失败？** 检查目标服务器网络和防火墙设置
- **服务无响应？** 查看日志：`ssh root@目标服务器IP 'cd /root/ilock && docker-compose logs'`
- **备份失败？** 确保源服务器上 Docker 容器正在运行
- **配置问题？** 检查 `/root/ilock/configs` 目录下的配置文件 